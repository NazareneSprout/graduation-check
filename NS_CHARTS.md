# SakMvp1 NS 차트 (Nassi-Shneiderman Chart)

## 목차
1. [졸업 요건 분석 프로세스](#1-졸업-요건-분석-프로세스)
2. [로그인 및 인증 프로세스](#2-로그인-및-인증-프로세스)
3. [과목 입력 프로세스](#3-과목-입력-프로세스)
4. [과목 추천 알고리즘](#4-과목-추천-알고리즘)
5. [대체과목 규칙 적용](#5-대체과목-규칙-적용)
6. [캐시 관리 프로세스](#6-캐시-관리-프로세스)

---

## 1. 졸업 요건 분석 프로세스

### GraduationRules.analyze() 메서드

```
┌────────────────────────────────────────────────────────────────┐
│ analyze(takenCourses: List<Course>): GraduationAnalysisResult │
├────────────────────────────────────────────────────────────────┤
│ 1. 분석 시작 로깅                                                │
│    - "Starting graduation analysis for: {docId}" 출력            │
│    - 수강 과목 개수 및 상세 정보 로깅                               │
├────────────────────────────────────────────────────────────────┤
│ 2. 결과 객체 초기화                                               │
│    - result = new GraduationAnalysisResult()                   │
│    - result.setDocId(docId)                                    │
│    - result.setCohort(String.valueOf(cohort))                  │
│    - result.setDepartment(department)                          │
│    - result.setTrack(track)                                    │
├────────────────────────────────────────────────────────────────┤
│ 3. 대체과목 규칙 적용                                             │
│    - adjustedCourses = applyReplacementRules(takenCourses,     │
│                                              result)            │
│    - 폐강된 과목을 대체 과목으로 매핑                               │
│    - 적용된 규칙을 result에 기록                                   │
├────────────────────────────────────────────────────────────────┤
│ 4. 카테고리별 분석 (반복)                                          │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ FOR EACH category IN categories                            │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.1 카테고리 분석 로깅                                        │ │
│ │     - "Analyzing category: {name} (id={id})" 출력           │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.2 카테고리 분석 실행                                        │ │
│ │     - categoryResult = category.analyze(adjustedCourses)   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.3 결과 저장                                                │ │
│ │     - categoryResults.put(category.getId(), categoryResult)│ │
│ │     - result.addCategoryResult(categoryResult)             │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.4 분석 결과 로깅                                            │ │
│ │     - "Category analyzed: {name} -> {earned}/{required}"   │ │
│ │     - 완료 여부, 이수 과목 수, 미이수 과목 수 출력              │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 5. 총 학점 계산                                                  │
│    - totalEarnedCredits = 0                                    │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ FOR EACH categoryResult IN categoryResults.values()        │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - credits = categoryResult.getEarnedCredits()              │ │
│ │ - totalEarnedCredits += credits                            │ │
│ │ - "+ {categoryName}: {credits}학점" 로깅                     │ │
│ └────────────────────────────────────────────────────────────┘ │
│    - result.setTotalEarnedCredits(totalEarnedCredits)          │
├────────────────────────────────────────────────────────────────┤
│ 6. 총 필요 학점 설정                                              │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF totalCredits > 0                                        │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE: result.setTotalRequiredCredits(totalCredits)         │ │
│ │       "Using totalCredits from document" 로깅               │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ FALSE:                                                     │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF creditRequirements != null AND                    │   │ │
│ │ │    creditRequirements.getTotal() > 0                 │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ TRUE: result.setTotalRequiredCredits(               │   │ │
│ │ │           creditRequirements.getTotal())             │   │ │
│ │ │       "Using creditRequirements.total" 로깅           │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ FALSE: 경고 로깅 "No total credits found!"           │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 7. 넘치는 학점 처리                                               │
│    - handleOverflowCredits(result, categoryResults)            │
├────────────────────────────────────────────────────────────────┤
│ 8. 졸업 가능 여부 계산                                            │
│    - result.calculateGraduationReadiness()                     │
│    - 모든 카테고리 충족 여부 확인                                  │
│    - 총 학점 충족 여부 확인                                       │
│    - 경고 및 추천사항 생성                                         │
├────────────────────────────────────────────────────────────────┤
│ 9. 분석 완료 로깅                                                 │
│    - "Analysis complete: Total {earned}/{required} credits"    │
│    - "Graduation ready: {isReady}" 출력                        │
├────────────────────────────────────────────────────────────────┤
│ RETURN result                                                  │
└────────────────────────────────────────────────────────────────┘
```

---

## 2. 로그인 및 인증 프로세스

### LoginActivity.onCreate() 및 로그인 플로우

```
┌────────────────────────────────────────────────────────────────┐
│ LoginActivity.onCreate()                                       │
├────────────────────────────────────────────────────────────────┤
│ 1. 초기화                                                        │
│    - EdgeToEdge.enable(this)                                   │
│    - setContentView(R.layout.activity_login)                   │
│    - mAuth = FirebaseAuth.getInstance()                        │
│    - UI 요소 바인딩 (etEmail, etPassword, cbAutoLogin, etc.)    │
├────────────────────────────────────────────────────────────────┤
│ 2. 자동 로그인 확인                                               │
│    - prefs = getSharedPreferences("user_prefs", MODE_PRIVATE)  │
│    - autoLogin = prefs.getBoolean("auto_login", false)         │
├────────────────────────────────────────────────────────────────┤
│ 3. 자동 로그인 처리                                               │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF autoLogin == true AND                                   │ │
│ │    mAuth.getCurrentUser() != null                          │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - checkUserRoleAndNavigate()                             │ │
│ │   - 로그인 화면 건너뛰고 메인으로 이동                         │ │
│ │   - finish()                                               │ │
│ │   - RETURN                                                 │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ FALSE: 로그인 화면 표시                                      │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 4. 버튼 리스너 설정                                               │
│    - btnLogin.setOnClickListener()                             │
│    - btnSignUp.setOnClickListener()                            │
│    - btnTestAccess.setOnClickListener()                        │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ performLogin() - 로그인 실행                                     │
├────────────────────────────────────────────────────────────────┤
│ 1. 입력값 검증                                                   │
│    - email = etEmail.getText().toString().trim()               │
│    - password = etPassword.getText().toString().trim()         │
├────────────────────────────────────────────────────────────────┤
│ 2. 입력값 유효성 검사                                             │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF email.isEmpty() OR password.isEmpty()                   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - Toast.makeText("이메일과 비밀번호를 입력하세요")          │ │
│ │   - RETURN                                                 │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 3. Firebase 인증 시도                                            │
│    - showProgressDialog()                                      │
│    - mAuth.signInWithEmailAndPassword(email, password)         │
├────────────────────────────────────────────────────────────────┤
│ 4. 인증 결과 처리                                                 │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON SUCCESS:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.1 자동 로그인 설정 저장                                     │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF cbAutoLogin.isChecked()                           │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ TRUE:                                                │   │ │
│ │ │   - prefs.edit()                                     │   │ │
│ │ │          .putBoolean("auto_login", true)             │   │ │
│ │ │          .apply()                                    │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.2 사용자 역할 확인 및 화면 전환                              │ │
│ │     - checkUserRoleAndNavigate()                           │ │
│ │     - hideProgressDialog()                                 │ │
│ │     - finish()                                             │ │
│ └────────────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON FAILURE:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.3 에러 타입별 처리                                          │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF exception is InvalidUserException                │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - Toast("존재하지 않는 사용자입니다")                  │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ ELSE IF exception is InvalidCredentialsException    │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - Toast("비밀번호가 올바르지 않습니다")                │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ ELSE                                                 │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - Toast("로그인 실패: " + e.getMessage())             │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ │     - hideProgressDialog()                                 │ │
│ └────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ checkUserRoleAndNavigate() - 사용자 역할 확인 및 화면 이동         │
├────────────────────────────────────────────────────────────────┤
│ 1. 현재 사용자 가져오기                                           │
│    - currentUser = mAuth.getCurrentUser()                      │
├────────────────────────────────────────────────────────────────┤
│ 2. Firestore에서 사용자 정보 조회                                 │
│    - db.collection("users")                                    │
│        .document(currentUser.getUid())                         │
│        .get()                                                  │
├────────────────────────────────────────────────────────────────┤
│ 3. 사용자 역할에 따른 화면 전환                                    │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON SUCCESS:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 3.1 관리자 여부 확인                                          │ │
│ │     - isAdmin = documentSnapshot.getBoolean("isAdmin")     │ │
│ │     - prefs.edit()                                         │ │
│ │            .putBoolean("is_admin", isAdmin)                │ │
│ │            .apply()                                        │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 3.2 화면 전환                                                 │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF isAdmin == true                                   │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - intent = new Intent(this, AdminActivity.class)    │   │ │
│ │ │ - startActivity(intent)                              │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ ELSE                                                 │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - intent = new Intent(this, MainActivityNew.class)  │   │ │
│ │ │ - startActivity(intent)                              │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ └────────────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON FAILURE:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - Log.e("Error loading user data", exception)              │ │
│ │ - Toast("사용자 정보를 불러오는데 실패했습니다")               │ │
│ │ - 기본적으로 MainActivityNew로 이동                          │ │
│ └────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

---

## 3. 과목 입력 프로세스

### CourseInputActivity - 강의 추가 플로우

```
┌────────────────────────────────────────────────────────────────┐
│ showAddCourseDialog() - 과목 추가 다이얼로그                      │
├────────────────────────────────────────────────────────────────┤
│ 1. 현재 카테고리 확인                                             │
│    - currentCategory = getCurrentSelectedCategory()            │
├────────────────────────────────────────────────────────────────┤
│ 2. 카테고리 선택 여부 검증                                         │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF currentCategory == null                                 │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - Toast("카테고리를 먼저 선택해주세요")                      │ │
│ │   - RETURN                                                 │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 3. 강의 데이터 로드                                               │
│    - showLoadingDialog()                                       │
│    - dataManager.loadCoursesForCategory(                       │
│          department, track, year, currentCategory, callback)   │
├────────────────────────────────────────────────────────────────┤
│ 4. 데이터 로드 결과 처리                                           │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON SUCCESS:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.1 이미 추가된 과목 필터링                                    │ │
│ │     - availableCourses = new ArrayList<>()                 │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ FOR EACH course IN loadedCourses                     │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ IF !alreadyAdded(course)                             │   │ │
│ │ │   - availableCourses.add(course)                     │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.2 사용 가능한 과목이 없는 경우                               │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF availableCourses.isEmpty()                        │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - showDirectInputOption()                            │   │ │
│ │ │ - RETURN                                             │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.3 다이얼로그 UI 구성                                        │ │
│ │     - dialogView = inflate(R.layout.dialog_add_course)     │ │
│ │     - spinnerCourse = dialogView.findViewById(...)         │ │
│ │     - editCredits = dialogView.findViewById(...)           │ │
│ │     - radioGroupCompletion = dialogView.findViewById(...)  │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.4 스피너 어댑터 설정                                         │ │
│ │     - adapter = new ArrayAdapter<>(availableCourses)       │ │
│ │     - spinnerCourse.setAdapter(adapter)                    │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.5 과목 선택 리스너                                           │ │
│ │     - spinnerCourse.setOnItemSelectedListener()            │ │
│ │       → selectedCourse가 변경되면 학점 자동 입력              │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.6 다이얼로그 표시                                            │ │
│ │     - AlertDialog.Builder(this)                            │ │
│ │         .setTitle("과목 추가")                              │ │
│ │         .setView(dialogView)                               │ │
│ │         .setPositiveButton("추가", onClick)                 │ │
│ │         .setNegativeButton("취소", null)                    │ │
│ │         .show()                                            │ │
│ └────────────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON FAILURE:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - hideLoadingDialog()                                      │ │
│ │ - Toast("강의 목록을 불러오는데 실패했습니다")                 │ │
│ │ - Log.e(TAG, "Error: " + error)                            │ │
│ └────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ addCourseToList() - 과목을 리스트에 추가                          │
├────────────────────────────────────────────────────────────────┤
│ 1. 과목 객체 생성                                                 │
│    - course = new Course()                                     │
│    - course.setName(courseName)                                │
│    - course.setCategory(currentCategory)                       │
│    - course.setCredits(credits)                                │
│    - course.setCompleted(isCompleted)                          │
├────────────────────────────────────────────────────────────────┤
│ 2. 중복 검사                                                     │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF isDuplicate(course)                                     │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - Toast("이미 추가된 과목입니다")                           │ │
│ │   - RETURN                                                 │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 3. 카테고리별 리스트에 추가                                        │
│    - categoryCoursesMap.get(currentCategory).add(course)       │
├────────────────────────────────────────────────────────────────┤
│ 4. UI 갱신                                                       │
│    - updateCategoryCreditsDisplay()                            │
│    - updateDonutChart()                                        │
│    - refreshCourseList()                                       │
├────────────────────────────────────────────────────────────────┤
│ 5. 애니메이션 효과                                                │
│    - courseItemView.startAnimation(fadeInAnimation)            │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ analyzeCourses() - 졸업 요건 분석 시작                            │
├────────────────────────────────────────────────────────────────┤
│ 1. 입력 검증                                                     │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF getAllCourses().isEmpty()                               │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - Toast("최소 1개 이상의 과목을 추가해주세요")              │ │
│ │   - RETURN                                                 │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 2. 중복 클릭 방지                                                 │
│    - btnAnalyze.setEnabled(false)                              │
│    - showProgressDialog("분석 중...")                           │
├────────────────────────────────────────────────────────────────┤
│ 3. 졸업 요건 데이터 로드                                           │
│    - dataManager.loadGraduationRequirements(                   │
│          department, track, year, callback)                    │
├────────────────────────────────────────────────────────────────┤
│ 4. 분석 실행                                                     │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON SUCCESS:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.1 GraduationRules 객체 생성                                │ │
│ │     - rules = new GraduationRules(cohort, dept, track)     │ │
│ │     - rules 설정 (categories, requirements, etc.)          │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.2 분석 실행                                                 │ │
│ │     - result = rules.analyze(getAllCourses())              │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 4.3 결과 화면으로 이동                                         │ │
│ │     - intent = new Intent(this,                            │ │
│ │         GraduationAnalysisResultActivity.class)            │ │
│ │     - intent.putExtra("result", gson.toJson(result))       │ │
│ │     - startActivity(intent)                                │ │
│ │     - hideProgressDialog()                                 │ │
│ │     - btnAnalyze.setEnabled(true)                          │ │
│ └────────────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON FAILURE:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - hideProgressDialog()                                     │ │
│ │ - btnAnalyze.setEnabled(true)                              │ │
│ │ - Toast("분석 중 오류가 발생했습니다")                         │ │
│ │ - Log.e(TAG, "Analysis error", exception)                  │ │
│ └────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. 과목 추천 알고리즘

### CourseRecommendationActivity - 추천 생성 프로세스

```
┌────────────────────────────────────────────────────────────────┐
│ generateRecommendations() - 과목 추천 생성                       │
├────────────────────────────────────────────────────────────────┤
│ 1. 입력 파라미터 수집                                             │
│    - targetGrade = spinnerGrade.getSelectedItem()              │
│    - targetSemester = spinnerSemester.getSelectedItem()        │
│    - priorityMode = getPriorityMode()                          │
│    - customCategory = spinnerCategoryPriority.getSelectedItem()│
├────────────────────────────────────────────────────────────────┤
│ 2. 사용자 학사 정보 로드                                           │
│    - userYear = prefs.getString("user_year", "")               │
│    - userDepartment = prefs.getString("user_department", "")   │
│    - userTrack = prefs.getString("user_track", "")             │
├────────────────────────────────────────────────────────────────┤
│ 3. 수강 이력 분석                                                 │
│    - takenCourses = loadUserCoursesFromFirestore()            │
│    - categoryCreditsMap = analyzeTakenCoursesByCategory()      │
├────────────────────────────────────────────────────────────────┤
│ 4. 우선순위 카테고리 결정                                          │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ SWITCH priorityMode                                        │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ CASE "shortage":                                           │ │
│ │   - priorityCategory = findMostShortageCategory(           │ │
│ │                         categoryCreditsMap)                │ │
│ │   - 부족한 학점이 가장 많은 카테고리 선택                       │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ CASE "abundant":                                           │ │
│ │   - priorityCategory = findMostAbundantCategory(           │ │
│ │                         categoryCreditsMap)                │ │
│ │   - 남은 학점이 가장 많은 카테고리 선택                         │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ CASE "custom":                                             │ │
│ │   - priorityCategory = customCategory                      │ │
│ │   - 사용자가 지정한 카테고리 사용                               │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 5. 과목 목록 로드                                                 │
│    - allCourses = dataManager.loadCoursesForCategory(          │
│                      userDepartment, userTrack, userYear,      │
│                      priorityCategory)                         │
├────────────────────────────────────────────────────────────────┤
│ 6. 과목 필터링                                                    │
│    - candidateCourses = new ArrayList<>()                      │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ FOR EACH course IN allCourses                              │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 6.1 이미 수강한 과목 제외                                      │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF alreadyTaken(course)                              │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - CONTINUE (다음 과목으로)                            │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 6.2 학년/학기 필터링                                           │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF course.getRecommendedGrade() <= targetGrade AND   │   │ │
│ │ │    course.getRecommendedSemester() <= targetSemester │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - candidateCourses.add(course)                       │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 7. 과목 정렬 및 점수 계산                                          │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ FOR EACH course IN candidateCourses                        │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - score = 0                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 7.1 필수 과목 가중치 (+50점)                                   │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF course.isRequired()                               │   │ │
│ │ │   - score += 50                                      │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 7.2 학년/학기 적합도 (+30~10점)                                │ │
│ │     - gradeDiff = abs(course.recommendedGrade - targetGrade)│ │
│ │     - score += (30 - gradeDiff * 10)                       │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 7.3 학점 수 고려 (+5~15점)                                     │ │
│ │     - score += course.getCredits() * 5                     │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 7.4 선이수 과목 충족 여부 (+20점 또는 -100점)                    │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF hasPrerequisites(course)                          │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ IF allPrerequisitesMet(course)                       │   │ │
│ │ │   - score += 20                                      │   │ │
│ │ │ ELSE                                                 │   │ │
│ │ │   - score -= 100 (실질적 제외)                        │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - course.setRecommendationScore(score)                     │ │
│ └────────────────────────────────────────────────────────────┘ │
│    - Collections.sort(candidateCourses, (a, b) ->              │
│         b.getRecommendationScore() - a.getRecommendationScore())│
├────────────────────────────────────────────────────────────────┤
│ 8. 추천 결과 생성                                                 │
│    - recommendedCourses = candidateCourses.subList(0,          │
│                              min(10, candidateCourses.size())) │
│    - totalRecommendedCredits = sum(course.getCredits())        │
├────────────────────────────────────────────────────────────────┤
│ 9. 결과 화면으로 이동                                              │
│    - intent = new Intent(this, RecommendationResultActivity)   │
│    - intent.putExtra("recommendations",                        │
│                      gson.toJson(recommendedCourses))          │
│    - intent.putExtra("priority_category", priorityCategory)    │
│    - intent.putExtra("total_credits", totalRecommendedCredits) │
│    - startActivity(intent)                                     │
└────────────────────────────────────────────────────────────────┘
```

---

## 5. 대체과목 규칙 적용

### GraduationRules.applyReplacementRules()

```
┌────────────────────────────────────────────────────────────────┐
│ applyReplacementRules(takenCourses, result)                    │
├────────────────────────────────────────────────────────────────┤
│ 1. 초기 검증                                                     │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF replacementRules == null OR replacementRules.isEmpty()  │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - Log.d("No replacement rules to apply")                 │ │
│ │   - RETURN takenCourses (변경 없이 반환)                     │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 2. 초기화                                                        │
│    - adjustedCourses = new ArrayList<>(takenCourses)           │
│    - appliedDiscontinuedCodes = new HashSet<>()                │
│    - Log.d("Found " + replacementRules.size() + " rules")      │
├────────────────────────────────────────────────────────────────┤
│ 3. 대체과목 규칙 적용 (각 과목에 대해)                             │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ FOR i = 0 TO adjustedCourses.size() - 1                    │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 3.1 현재 과목 가져오기                                         │ │
│ │     - course = adjustedCourses.get(i)                      │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 3.2 해당 과목의 대체 규칙 찾기                                  │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ FOR EACH rule IN replacementRules                    │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ 3.2.1 대체과목 코드 일치 확인                           │   │ │
│ │ │ ┌────────────────────────────────────────────────┐   │   │ │
│ │ │ │ IF course.getCode() ==                         │   │   │ │
│ │ │ │    rule.getReplacementCourseCode()             │   │   │ │
│ │ │ ├────────────────────────────────────────────────┤   │   │ │
│ │ │ │ TRUE:                                          │   │   │ │
│ │ │ │   - discontinuedCode =                         │   │   │ │
│ │ │ │       rule.getDiscontinuedCourseCode()         │   │   │ │
│ │ │ └────────────────────────────────────────────────┘   │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ 3.2.2 중복 인정 방지 (이미 적용된 폐강 과목인가?)       │   │ │
│ │ │ ┌────────────────────────────────────────────────┐   │   │ │
│ │ │ │ IF appliedDiscontinuedCodes.contains(          │   │   │ │
│ │ │ │        discontinuedCode)                       │   │   │ │
│ │ │ ├────────────────────────────────────────────────┤   │   │ │
│ │ │ │ TRUE:                                          │   │   │ │
│ │ │ │   - Log.d("이미 적용된 대체과목, 원래 카테고리 유지") │   │   │ │
│ │ │ │   - CONTINUE (다음 규칙으로)                    │   │   │ │
│ │ │ └────────────────────────────────────────────────┘   │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ 3.2.3 대체과목 적용                                    │   │ │
│ │ │     - originalCategory = course.getCategory()          │   │ │
│ │ │     - course.setCategory(                              │   │ │
│ │ │         rule.getReplacementCategory())                 │   │ │
│ │ │     - course.setReplacedFrom(discontinuedCode)         │   │ │
│ │ │     - appliedDiscontinuedCodes.add(discontinuedCode)   │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ 3.2.4 적용 로깅                                         │   │ │
│ │ │     - Log.d("대체과목 적용: " +                         │   │ │
│ │ │             course.getName() + " [" +                  │   │ │
│ │ │             originalCategory + " → " +                 │   │ │
│ │ │             rule.getReplacementCategory() + "]")       │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ 3.2.5 결과에 기록                                       │   │ │
│ │ │     - result.addAppliedReplacement(rule)               │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ 3.2.6 규칙 적용 완료, 다음 과목으로                      │   │ │
│ │ │     - BREAK (내부 FOR 루프 종료)                        │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 4. 적용 결과 로깅                                                 │
│    - Log.d("Applied " + appliedDiscontinuedCodes.size() +      │
│            " replacement rules")                               │
├────────────────────────────────────────────────────────────────┤
│ RETURN adjustedCourses                                         │
└────────────────────────────────────────────────────────────────┘
```

---

## 6. 캐시 관리 프로세스

### FirebaseDataManager - 캐싱 전략

```
┌────────────────────────────────────────────────────────────────┐
│ loadCoursesForCategory(dept, track, year, category, callback)  │
├────────────────────────────────────────────────────────────────┤
│ 1. 캐시 키 생성                                                  │
│    - cacheKey = dept + "_" + track + "_" + year + "_" +        │
│                 category                                       │
│    - Log.d("Looking for courses with key: " + cacheKey)        │
├────────────────────────────────────────────────────────────────┤
│ 2. 캐시 확인                                                     │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF coursesCache.containsKey(cacheKey)                      │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE:                                                      │ │
│ │   - cachedCourses = coursesCache.get(cacheKey)             │ │
│ │   - Log.d("Cache HIT: Returning " +                        │ │
│ │           cachedCourses.size() + " courses")               │ │
│ │   - callback.onSuccess(cachedCourses)                      │ │
│ │   - RETURN                                                 │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 3. 캐시 미스 - Firestore 조회                                    │
│    - Log.d("Cache MISS: Loading from Firestore")              │
│    - isMajor = category.startsWith("major")                    │
├────────────────────────────────────────────────────────────────┤
│ 4. 문서 ID 결정                                                  │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF isMajor                                                 │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ TRUE: (전공 과목)                                           │ │
│ │   - docId = "전공_" + dept + "_" + track + "_" + year       │ │
│ │   - fallbackDocId = "전공_" + dept + "_공통_" + year        │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ FALSE: (교양 과목)                                          │ │
│ │   - docId = "교양_" + dept + "_" + year                     │ │
│ │   - fallbackDocId = "교양_공통_" + year                     │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 5. Firestore에서 문서 조회                                       │
│    - db.collection("graduation_requirements")                  │
│        .document(docId)                                        │
│        .get()                                                  │
├────────────────────────────────────────────────────────────────┤
│ 6. 조회 결과 처리                                                 │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON SUCCESS:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ 6.1 문서 존재 확인                                            │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ IF documentSnapshot.exists()                         │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - courses = parseCoursesFromDocument(               │   │ │
│ │ │                 documentSnapshot, category)          │   │ │
│ │ │ - coursesCache.put(cacheKey, courses)                │   │ │
│ │ │ - Log.d("Loaded and cached " + courses.size() +     │   │ │
│ │ │         " courses")                                  │   │ │
│ │ │ - callback.onSuccess(courses)                        │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ │ ┌──────────────────────────────────────────────────────┐   │ │
│ │ │ ELSE (문서 없음 - Fallback 시도)                       │   │ │
│ │ ├──────────────────────────────────────────────────────┤   │ │
│ │ │ - Log.d("Document not found, trying fallback: " +   │   │ │
│ │ │         fallbackDocId)                               │   │ │
│ │ │ - loadFromFallbackDocument(fallbackDocId,           │   │ │
│ │ │       category, cacheKey, callback)                  │   │ │
│ │ └──────────────────────────────────────────────────────┘   │ │
│ └────────────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ ON FAILURE:                                                │ │
│ ├────────────────────────────────────────────────────────────┤ │
│ │ - Log.e("Error loading courses", exception)                │ │
│ │ - callback.onFailure("강의 목록을 불러오는데 실패했습니다")     │ │
│ └────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ clearCache() - 전체 캐시 초기화                                   │
├────────────────────────────────────────────────────────────────┤
│ 1. 각 캐시 맵 초기화                                              │
│    - studentYearsCache.clear()                                 │
│    - departmentsCache.clear()                                  │
│    - tracksCache.clear()                                       │
│    - coursesCache.clear()                                      │
│    - graduationCache.clear()                                   │
│    - generalDocCache.clear()                                   │
│    - majorDocCache.clear()                                     │
│    - deptCommonDocCache.clear()                                │
├────────────────────────────────────────────────────────────────┤
│ 2. DocumentSnapshot 캐시 초기화                                  │
│    - docSnapshotCache.clear()                                  │
├────────────────────────────────────────────────────────────────┤
│ 3. 로깅                                                          │
│    - Log.d("All caches cleared")                               │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ N+1 쿼리 방지 메커니즘                                            │
├────────────────────────────────────────────────────────────────┤
│ 개념: 동일한 Firestore 문서를 반복 조회하지 않도록                 │
│       DocumentSnapshot을 메모리에 캐싱                           │
├────────────────────────────────────────────────────────────────┤
│ docSnapshotCache: Map<String, DocumentSnapshot>                │
│   - Key: Firestore 문서 ID                                     │
│   - Value: 조회된 DocumentSnapshot 객체                        │
├────────────────────────────────────────────────────────────────┤
│ 사용 예시:                                                       │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ IF docSnapshotCache.containsKey(docId)                     │ │
│ │   - snapshot = docSnapshotCache.get(docId)                 │ │
│ │   - 네트워크 요청 없이 즉시 사용                               │ │
│ │ ELSE                                                       │ │
│ │   - Firestore 조회 수행                                     │ │
│ │   - docSnapshotCache.put(docId, snapshot)                  │ │
│ │   - 다음 조회부터는 캐시 사용                                  │ │
│ └────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 효과:                                                            │
│   - 동일 문서 반복 조회 시 네트워크 요청 0회                       │
│   - 응답 시간 감소 (수백ms → 수ms)                               │
│   - Firestore 읽기 비용 절감                                    │
└────────────────────────────────────────────────────────────────┘
```

---

## 부록: NS 차트 표기법 설명

NS 차트(Nassi-Shneiderman Chart)는 구조적 프로그래밍을 시각적으로 표현하는 방법입니다.

### 기본 구조

1. **순차 구조** (Sequential):
```
┌─────────────────────┐
│ 명령 1              │
├─────────────────────┤
│ 명령 2              │
├─────────────────────┤
│ 명령 3              │
└─────────────────────┘
```

2. **선택 구조** (Selection):
```
┌─────────────────────────────────┐
│ IF 조건                          │
├─────────────┬───────────────────┤
│ TRUE: 명령A │ FALSE: 명령B      │
└─────────────┴───────────────────┘
```

3. **반복 구조** (Iteration):
```
┌─────────────────────────────────┐
│ FOR EACH item IN collection     │
├─────────────────────────────────┤
│ 반복 실행할 명령들               │
└─────────────────────────────────┘
```

### 장점

- **구조적**: 제어 흐름이 명확하게 보임
- **GOTO 없음**: 스파게티 코드 방지
- **가독성**: 논리 구조를 한눈에 파악 가능
- **문서화**: 코드 설계 및 리뷰에 유용

---

## 문서 작성 정보

- **작성일**: 2025-11-25
- **버전**: 1.0
- **작성자**: Claude Code Architecture Analyzer
- **프로젝트**: SakMvp1 (Student Academic Knowledge Management)
